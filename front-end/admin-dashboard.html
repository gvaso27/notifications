<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Notification System - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2em;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 100px auto;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            min-width: 120px;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-tab:not(.active):hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096, #4a5568);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .customer-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .customer-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .customer-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #667eea;
        }

        .search-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .notification-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .notification-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-delivered { background: #c6f6d5; color: #22543d; }
        .status-pending { background: #fef5e7; color: #744210; }
        .status-failed { background: #fed7d7; color: #742a2a; }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1em;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .small-btn {
            padding: 5px 10px;
            font-size: 12px;
            margin: 2px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .preference-item {
            background: #f7fafc;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                margin-bottom: 5px;
            }
            
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .customer-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginContainer" class="login-container">
        <h2 style="text-align: center; margin-bottom: 30px; color: #4a5568;">Admin Login</h2>
        <div id="loginAlert"></div>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">Login</button>
        </form>
        <div style="text-align: center; margin-top: 20px;">
            <p>Don't have an account? <a href="#" id="showRegister" style="color: #667eea;">Register here</a></p>
        </div>
        
        <!-- Registration Form (initially hidden) -->
        <div id="registerForm" class="hidden" style="margin-top: 30px; padding-top: 30px; border-top: 1px solid #e2e8f0;">
            <h3 style="text-align: center; margin-bottom: 20px; color: #4a5568;">Create Admin Account</h3>
            <form id="adminRegisterForm">
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="container hidden">
        <div class="header">
            <h1>Customer Notification System</h1>
            <div class="user-info">
                <span id="welcomeText">Welcome, Admin</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('customers')">Customers</div>
            <div class="nav-tab" onclick="showTab('notifications')">Notifications</div>
            <div class="nav-tab" onclick="showTab('preferences')">Preferences</div>
            <div class="nav-tab" onclick="showTab('addresses')">Addresses</div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content active">
            <h2 style="margin-bottom: 20px; color: #4a5568;">Customer Management</h2>
            
            <!-- Add Customer Form -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 20px; color: #667eea;">Add New Customer</h3>
                <div id="customerAlert"></div>
                <form id="customerForm">
                    <div class="form-group">
                        <label for="customerName">Customer Name</label>
                        <input type="text" id="customerName" required>
                    </div>
                    
                    <h4 style="margin: 20px 0 15px 0; color: #4a5568;">Addresses</h4>
                    <div id="addressesContainer">
                        <div class="form-row address-row">
                            <div class="form-group">
                                <label>Address Type</label>
                                <select class="addressType" required>
                                    <option value="">Select Type</option>
                                    <option value="EMAIL">Email</option>
                                    <option value="SMS">SMS</option>
                                    <option value="POSTAL">Postal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Address Value</label>
                                <input type="text" class="addressValue" required placeholder="Enter address">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary small-btn" onclick="addAddressField()">+ Add Address</button>
                    
                    <h4 style="margin: 20px 0 15px 0; color: #4a5568;">Notification Preferences</h4>
                    <div id="preferencesContainer">
                        <div class="form-group">
                            <select class="preferenceType" required>
                                <option value="">Select Preference</option>
                                <option value="EMAIL">Email Notifications</option>
                                <option value="SMS">SMS Notifications</option>
                                <option value="POSTAL">Postal</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary small-btn" onclick="addPreferenceField()">+ Add Preference</button>
                    
                    <div style="margin-top: 30px;">
                        <button type="submit" class="btn">Create Customer</button>
                    </div>
                </form>
            </div>

            <!-- Search/Filter Customers -->
            <div class="search-container">
                <h3 style="margin-bottom: 20px; color: #667eea;">Search & Filter Customers</h3>
                <form id="searchForm" class="search-form">
                    <div class="form-group">
                        <label for="filterType">Filter Type</label>
                        <select id="filterType" required>
                            <option value="">Select Filter</option>
                            <option value="ID">By ID</option>
                            <option value="NAME">By Name</option>
                            <option value="ADDRESS_TYPE">By Address Type</option>
                            <option value="ADDRESS_VALUE">By Address Value</option>
                            <option value="PREFERENCE_TYPE">By Preference</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchValue">Search Value</label>
                        <input type="text" id="searchValue" placeholder="Enter search value">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">Search</button>
                        <button type="button" class="btn btn-secondary" onclick="loadAllCustomers()">Show All</button>
                    </div>
                </form>
            </div>

            <!-- Customers List -->
            <div id="customersList">
                <div class="loading">Loading customers...</div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #4a5568;">Notification Management</h2>

            <!-- Send Notification Form -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 20px; color: #667eea;">Send Notification</h3>
                <div id="notificationAlert"></div>
                <form id="notificationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="receiverId">Customer ID</label>
                            <input type="number" id="receiverId" required>
                        </div>
                        <div class="form-group">
                            <label for="message">Message</label>
                            <textarea id="message" rows="3" required placeholder="Enter notification message"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn">Send Notification</button>
                </form>
            </div>

            <!-- Filter Notifications -->
            <div class="search-container">
                <h3 style="margin-bottom: 20px; color: #667eea;">Filter Notifications by Status</h3>
                <div class="search-form">
                    <div class="form-group">
                        <label for="statusFilter">Status</label>
                        <select id="statusFilter">
                            <option value="">All Notifications</option>
                            <option value="PENDING">Pending</option>
                            <option value="DELIVERED">Delivered</option>
                            <option value="FAILED">Failed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn" onclick="filterNotifications()">Filter</button>
                    </div>
                </div>
            </div>

            <!-- Notifications List -->
            <div id="notificationsList">
                <div class="loading">Loading notifications...</div>
            </div>
        </div>

        <!-- Preferences Tab -->
        <div id="preferences" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #4a5568;">Notification Preferences Management</h2>

            <!-- Add Preference Form -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 20px; color: #667eea;">Add Notification Preference</h3>
                <div id="preferenceAlert"></div>
                <form id="preferenceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="prefCustomerId">Customer ID</label>
                            <input type="number" id="prefCustomerId" required>
                        </div>
                        <div class="form-group">
                            <label for="preferenceType">Preference Type</label>
                            <select id="preferenceType" required>
                                <option value="">Select Preference</option>
                                <option value="EMAIL">Email Notifications</option>
                                <option value="SMS">SMS Notifications</option>
                                <option value="POSTAL">Postal</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn">Add Preference</button>
                </form>
            </div>

            <!-- Get Customer Preferences -->
            <div class="search-container">
                <h3 style="margin-bottom: 20px; color: #667eea;">View Customer Preferences</h3>
                <div class="search-form">
                    <div class="form-group">
                        <label for="viewPrefCustomerId">Customer ID</label>
                        <input type="number" id="viewPrefCustomerId" placeholder="Enter customer ID">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn" onclick="loadCustomerPreferences()">Load Preferences</button>
                    </div>
                </div>
            </div>

            <!-- Preferences List -->
            <div id="preferencesList"></div>
        </div>

        <!-- Addresses Tab -->
        <div id="addresses" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #4a5568;">Address Management</h2>

            <!-- Add Address Form -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 20px; color: #667eea;">Add Address to Customer</h3>
                <div id="addressAlert"></div>
                <form id="addressForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addrCustomerId">Customer ID</label>
                            <input type="number" id="addrCustomerId" required>
                        </div>
                        <div class="form-group">
                            <label for="addrType">Address Type</label>
                            <select id="addrType" required>
                                <option value="">Select Type</option>
                                <option value="EMAIL">Email</option>
                                <option value="SMS">SMS</option>
                                <option value="POSTAL">Postal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="addrValue">Address Value</label>
                            <input type="text" id="addrValue" required placeholder="Enter address">
                        </div>
                    </div>
                    <button type="submit" class="btn">Add Address</button>
                </form>
            </div>

            <!-- Update Address Form -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 20px; color: #667eea;">Update Address</h3>
                <form id="updateAddressForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="updateAddrId">Address ID</label>
                            <input type="number" id="updateAddrId" required>
                        </div>
                        <div class="form-group">
                            <label for="updateAddrType">Address Type</label>
                            <select id="updateAddrType" required>
                                <option value="">Select Type</option>
                                <option value="EMAIL">Email</option>
                                <option value="SMS">SMS</option>
                                <option value="POSTAL">Postal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="updateAddrValue">Address Value</label>
                            <input type="text" id="updateAddrValue" required placeholder="Enter new address">
                        </div>
                    </div>
                    <button type="submit" class="btn">Update Address</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentToken = null;
        let currentUsername = null;
        const API_BASE = 'http://localhost:8081/api';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedToken = localStorage.getItem('adminToken');
            const savedUsername = localStorage.getItem('adminUsername');

            if (savedToken && savedUsername) {
                currentToken = savedToken;
                currentUsername = savedUsername;
                showDashboard();
                loadAllCustomers();
            }

            // Event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('adminRegisterForm').addEventListener('submit', handleRegister);
            document.getElementById('customerForm').addEventListener('submit', handleCreateCustomer);
            document.getElementById('searchForm').addEventListener('submit', handleSearch);
            document.getElementById('notificationForm').addEventListener('submit', handleSendNotification);
            document.getElementById('preferenceForm').addEventListener('submit', handleAddPreference);
            document.getElementById('addressForm').addEventListener('submit', handleAddAddress);
            document.getElementById('updateAddressForm').addEventListener('submit', handleUpdateAddress);

            document.getElementById('showRegister').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('registerForm').classList.toggle('hidden');
            });
        });

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/admins/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    currentUsername = data.username;

                    // Save to localStorage
                    localStorage.setItem('adminToken', currentToken);
                    localStorage.setItem('adminUsername', currentUsername);

                    showAlert('loginAlert', 'Login successful!', 'success');
                    setTimeout(() => {
                        showDashboard();
                        loadAllCustomers();
                    }, 1000);
                } else {
                    showAlert('loginAlert', 'Invalid username or password', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'Login failed. Please try again.', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;

            try {
                const response = await fetch(`${API_BASE}/admins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    showAlert('loginAlert', 'Account created successfully! Please login.', 'success');
                    document.getElementById('registerForm').classList.add('hidden');
                    document.getElementById('adminRegisterForm').reset();
                } else {
                    showAlert('loginAlert', 'Failed to create account', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'Registration failed. Please try again.', 'error');
            }
        }

        function logout() {
            currentToken = null;
            currentUsername = null;
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUsername');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        }

        function showDashboard() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('welcomeText').textContent = `Welcome, ${currentUsername}`;
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked nav tab
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'notifications') {
                loadAllNotifications();
            }
        }

        // Customer management functions
        async function handleCreateCustomer(e) {
            e.preventDefault();

            const customerName = document.getElementById('customerName').value;
            const addressRows = document.querySelectorAll('.address-row');
            const preferenceSelects = document.querySelectorAll('.preferenceType');

            // Collect addresses
            const addresses = [];
            addressRows.forEach(row => {
                const type = row.querySelector('.addressType').value;
                const value = row.querySelector('.addressValue').value;
                if (type && value) {
                    addresses.push({
                        addressType: type,
                        addressValue: value
                    });
                }
            });

            // Collect preferences
            const notificationPreferences = [];
            preferenceSelects.forEach(select => {
                if (select.value) {
                    notificationPreferences.push({
                        notificationPreferenceType: select.value
                    });
                }
            });

            if (addresses.length === 0) {
                showAlert('customerAlert', 'Please add at least one address', 'error');
                return;
            }

            const customerData = {
                name: customerName,
                addresses: addresses,
                notificationPreferences: notificationPreferences
            };

            try {
                const response = await fetch(`${API_BASE}/customers/create_customer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(customerData)
                });

                if (response.ok) {
                    showAlert('customerAlert', 'Customer created successfully!', 'success');
                    document.getElementById('customerForm').reset();
                    resetDynamicFields();
                    loadAllCustomers();
                } else {
                    const errorText = await response.text();
                    showAlert('customerAlert', `Failed to create customer: ${errorText}`, 'error');
                }
            } catch (error) {
                showAlert('customerAlert', 'Error creating customer. Please try again.', 'error');
            }
        }

        async function loadAllCustomers() {
            try {
                const response = await fetch(`${API_BASE}/customers`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayCustomers(data.customers);
                } else {
                    document.getElementById('customersList').innerHTML = '<div class="alert alert-error">Failed to load customers</div>';
                }
            } catch (error) {
                document.getElementById('customersList').innerHTML = '<div class="alert alert-error">Error loading customers</div>';
            }
        }

        async function handleSearch(e) {
            e.preventDefault();

            const filterType = document.getElementById('filterType').value;
            const searchValue = document.getElementById('searchValue').value;

            if (!filterType || !searchValue) {
                showAlert('customerAlert', 'Please select filter type and enter search value', 'error');
                return;
            }

            const params = new URLSearchParams({
                filterType: filterType
            });

            // Add the appropriate parameter based on filter type
            switch(filterType) {
                case 'ID':
                    params.append('id', searchValue);
                    break;
                case 'NAME':
                    params.append('name', searchValue);
                    break;
                case 'ADDRESS_TYPE':
                    params.append('addressType', searchValue);
                    break;
                case 'ADDRESS_VALUE':
                    params.append('addressValue', searchValue);
                    break;
                case 'PREFERENCE_TYPE':
                    params.append('notificationPreferenceType', searchValue);
                    break;
            }

            try {
                const response = await fetch(`${API_BASE}/customers/search-byUniqueAttribute?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayCustomers(data.customers);
                } else {
                    document.getElementById('customersList').innerHTML = '<div class="alert alert-error">No customers found</div>';
                }
            } catch (error) {
                document.getElementById('customersList').innerHTML = '<div class="alert alert-error">Error searching customers</div>';
            }
        }

        function displayCustomers(customers) {
            const container = document.getElementById('customersList');
            
            if (!customers || customers.length === 0) {
                container.innerHTML = '<div class="alert alert-error">No customers found</div>';
                return;
            }

            let html = '';
            customers.forEach(customer => {
                html += `
                    <div class="customer-card">
                        <div class="customer-name">
                            ${customer.name} (ID: ${customer.id})
                            <button class="btn btn-secondary small-btn" onclick="updateCustomerName(${customer.id}, '${customer.name}')">Edit Name</button>
                            <button class="btn btn-danger small-btn" onclick="deleteCustomer(${customer.id})">Delete</button>
                        </div>
                        <div class="customer-details">
                            <div class="detail-group">
                                <div class="detail-title">📧 Addresses</div>
                                ${customer.addresses.map(addr => `
                                    <div class="detail-item">
                                        <span><strong>${addr.addressType} (ID: ${addr.id}):</strong> ${addr.addressValue}</span>
                                        <button class="btn btn-danger small-btn" onclick="deleteAddress(${addr.id})">Delete</button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="detail-group">
                                <div class="detail-title">🔔 Preferences</div>
                                ${customer.notificationPreferences.map(pref => `
                                    <div class="detail-item">
                                        <span><strong>(ID: ${pref.id}):</strong> ${pref.notificationPreferenceType}</span>
                                        <button class="btn btn-danger small-btn" onclick="deletePreference(${pref.id})">Delete</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function updateCustomerName(customerId, currentName) {
            const newName = prompt('Enter new name:', currentName);
            if (!newName || newName === currentName) return;

            try {
                const response = await fetch(`${API_BASE}/customers/update_name`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        id: customerId,
                        newName: newName
                    })
                });

                if (response.ok) {
                    loadAllCustomers();
                    showAlert('customerAlert', 'Customer name updated successfully!', 'success');
                } else {
                    showAlert('customerAlert', 'Failed to update customer name', 'error');
                }
            } catch (error) {
                showAlert('customerAlert', 'Error updating customer name', 'error');
            }
        }

        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer?')) return;

            try {
                const response = await fetch(`${API_BASE}/customers/remove_customer/${customerId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                });

                if (response.ok) {
                    loadAllCustomers();
                    showAlert('customerAlert', 'Customer deleted successfully!', 'success');
                } else {
                    showAlert('customerAlert', 'Failed to delete customer', 'error');
                }
            } catch (error) {
                showAlert('customerAlert', 'Error deleting customer', 'error');
            }
        }

        // Notification management functions
        async function handleSendNotification(e) {
            e.preventDefault();
            
            const receiverId = document.getElementById('receiverId').value;
            const message = document.getElementById('message').value;

            try {
                const response = await fetch(`${API_BASE}/customers/notification/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        receiverId: receiverId,
                        message: message
                    })
                });

                if (response.ok) {
                    showAlert('notificationAlert', 'Notification sent successfully!', 'success');
                    document.getElementById('notificationForm').reset();
                    loadAllNotifications();
                } else {
                    showAlert('notificationAlert', 'Failed to send notification', 'error');
                }
            } catch (error) {
                showAlert('notificationAlert', 'Error sending notification', 'error');
            }
        }

        async function loadAllNotifications() {
            try {
                const response = await fetch(`${API_BASE}/customers/notification/get-by-status?status=PENDING`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayNotifications(data.notifications);
                } else {
                    document.getElementById('notificationsList').innerHTML = '<div class="alert alert-error">No notifications found</div>';
                }
            } catch (error) {
                document.getElementById('notificationsList').innerHTML = '<div class="alert alert-error">Error loading notifications</div>';
            }
        }

        async function filterNotifications() {
            const status = document.getElementById('statusFilter').value;
            
            if (!status) {
                loadAllNotifications();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/customers/notification/get-by-status?status=${status}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayNotifications(data.notifications);
                } else {
                    document.getElementById('notificationsList').innerHTML = '<div class="alert alert-error">No notifications found</div>';
                }
            } catch (error) {
                document.getElementById('notificationsList').innerHTML = '<div class="alert alert-error">Error loading notifications</div>';
            }
        }

        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsList');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<div class="alert alert-error">No notifications found</div>';
                return;
            }

            let html = '';
            notifications.forEach(notification => {
                html += `
                    <div class="notification-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <strong>Notification ID:</strong> ${notification.id}<br>
                                <strong>Receiver ID:</strong> ${notification.receiverId}
                            </div>
                            <div>
                                <span class="notification-status status-${notification.status.toLowerCase()}">
                                    ${notification.status}
                                </span>
                                <button class="btn btn-secondary small-btn" onclick="updateNotificationStatus('${notification.id}', '${notification.status}')">Update Status</button>
                            </div>
                        </div>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                            <strong>Message:</strong><br>
                            ${notification.message}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function updateNotificationStatus(notificationId, currentStatus) {
            const statuses = ['PENDING', 'DELIVERED', 'FAILED'];
            const newStatus = prompt(`Select new status (${statuses.join(', ')}):`, currentStatus);
            
            if (!newStatus || !statuses.includes(newStatus.toUpperCase()) || newStatus.toUpperCase() === currentStatus) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/customers/notification/update-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        notificationId: notificationId,
                        status: newStatus.toUpperCase()
                    })
                });

                if (response.ok) {
                    showAlert('notificationAlert', 'Notification status updated successfully!', 'success');
                    filterNotifications(); // Reload current filter
                } else {
                    showAlert('notificationAlert', 'Failed to update notification status', 'error');
                }
            } catch (error) {
                showAlert('notificationAlert', 'Error updating notification status', 'error');
            }
        }

        // Preference management functions
        async function handleAddPreference(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('prefCustomerId').value;
            const preferenceType = document.getElementById('preferenceType').value;

            try {
                const response = await fetch(`${API_BASE}/customers/notification_preferencies/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        customerId: parseInt(customerId),
                        notificationPreferenceDTO: {
                            notificationPreferenceType: preferenceType
                        }
                    })
                });

                if (response.ok) {
                    showAlert('preferenceAlert', 'Notification preference added successfully!', 'success');
                    document.getElementById('preferenceForm').reset();
                } else {
                    showAlert('preferenceAlert', 'Failed to add notification preference', 'error');
                }
            } catch (error) {
                showAlert('preferenceAlert', 'Error adding notification preference', 'error');
            }
        }

        async function loadCustomerPreferences() {
            const customerId = document.getElementById('viewPrefCustomerId').value;
            
            if (!customerId) {
                showAlert('preferenceAlert', 'Please enter a customer ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/customers/notification_preferencies/get_preferences?customerId=${customerId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayCustomerPreferences(data.notificationPreferencesDTO, customerId);
                } else {
                    document.getElementById('preferencesList').innerHTML = '<div class="alert alert-error">No preferences found for this customer</div>';
                }
            } catch (error) {
                document.getElementById('preferencesList').innerHTML = '<div class="alert alert-error">Error loading preferences</div>';
            }
        }

        function displayCustomerPreferences(preferences, customerId) {
            const container = document.getElementById('preferencesList');
            
            if (!preferences || preferences.length === 0) {
                container.innerHTML = '<div class="alert alert-error">No preferences found for this customer</div>';
                return;
            }

            let html = `<div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 20px; color: #667eea;">Preferences for Customer ID: ${customerId}</h3>`;
            
            preferences.forEach(preference => {
                html += `
                    <div class="preference-item">
                        <span><strong>${preference.notificationPreferenceType}</strong> (ID: ${preference.id})</span>
                        <button class="btn btn-danger small-btn" onclick="deletePreference(${preference.id})">Delete</button>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function deletePreference(preferenceId) {
            if (!confirm('Are you sure you want to delete this preference?')) return;

            try {
                const response = await fetch(`${API_BASE}/customers/notification_preferencies/delete_preference/${preferenceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                });

                if (response.ok) {
                    showAlert('preferenceAlert', 'Preference deleted successfully!', 'success');
                    // Reload preferences if we're viewing them
                    const customerId = document.getElementById('viewPrefCustomerId').value;
                    if (customerId) {
                        loadCustomerPreferences();
                    }
                    // Also reload customers to update the display
                    loadAllCustomers();
                } else {
                    showAlert('preferenceAlert', 'Failed to delete preference', 'error');
                }
            } catch (error) {
                showAlert('preferenceAlert', 'Error deleting preference', 'error');
            }
        }

        // Address management functions
        async function handleAddAddress(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('addrCustomerId').value;
            const addressType = document.getElementById('addrType').value;
            const addressValue = document.getElementById('addrValue').value;

            try {
                const response = await fetch(`${API_BASE}/customers/addresses/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        customerId: parseInt(customerId),
                        addressDTO: {
                            addressType: addressType,
                            addressValue: addressValue
                        }
                    })
                });

                if (response.ok) {
                    showAlert('addressAlert', 'Address added successfully!', 'success');
                    document.getElementById('addressForm').reset();
                    loadAllCustomers();
                } else {
                    showAlert('addressAlert', 'Failed to add address', 'error');
                }
            } catch (error) {
                showAlert('addressAlert', 'Error adding address', 'error');
            }
        }

        async function handleUpdateAddress(e) {
            e.preventDefault();
            
            const addressId = document.getElementById('updateAddrId').value;
            const addressType = document.getElementById('updateAddrType').value;
            const addressValue = document.getElementById('updateAddrValue').value;

            try {
                const response = await fetch(`${API_BASE}/customers/addresses/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        id: parseInt(addressId),
                        addressType: addressType,
                        addressValue: addressValue
                    })
                });

                if (response.ok) {
                    showAlert('addressAlert', 'Address updated successfully!', 'success');
                    document.getElementById('updateAddressForm').reset();
                    loadAllCustomers();
                } else {
                    showAlert('addressAlert', 'Failed to update address', 'error');
                }
            } catch (error) {
                showAlert('addressAlert', 'Error updating address', 'error');
            }
        }

        async function deleteAddress(addressId) {
            if (!confirm('Are you sure you want to delete this address?')) return;

            try {
                const response = await fetch(`${API_BASE}/customers/addresses/delete_address/${addressId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                });

                if (response.ok) {
                    showAlert('customerAlert', 'Address deleted successfully!', 'success');
                    loadAllCustomers();
                } else {
                    showAlert('customerAlert', 'Failed to delete address', 'error');
                }
            } catch (error) {
                showAlert('customerAlert', 'Error deleting address', 'error');
            }
        }

        // Dynamic form field functions
        function addAddressField() {
            const container = document.getElementById('addressesContainer');
            const newRow = document.createElement('div');
            newRow.className = 'form-row address-row';
            newRow.innerHTML = `
                <div class="form-group">
                    <label>Address Type</label>
                    <select class="addressType" required>
                        <option value="">Select Type</option>
                        <option value="EMAIL">Email</option>
                        <option value="SMS">SMS</option>
                        <option value="POSTAL">Postal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Address Value</label>
                    <input type="text" class="addressValue" required placeholder="Enter address">
                </div>
                <div class="form-group" style="display: flex; align-items: end;">
                    <button type="button" class="btn btn-danger small-btn" onclick="removeAddressField(this)">Remove</button>
                </div>
            `;
            container.appendChild(newRow);
        }

        function removeAddressField(button) {
            button.closest('.address-row').remove();
        }

        function addPreferenceField() {
            const container = document.getElementById('preferencesContainer');
            const newField = document.createElement('div');
            newField.className = 'form-group preference-field';
            newField.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: end;">
                    <div style="flex: 1;">
                        <select class="preferenceType" required>
                            <option value="">Select Preference</option>
                            <option value="EMAIL">Email Notifications</option>
                                <option value="SMS">SMS Notifications</option>
                                <option value="POSTAL">Postal</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-danger small-btn" onclick="removePreferenceField(this)">Remove</button>
                </div>
            `;
            container.appendChild(newField);
        }

        function removePreferenceField(button) {
            button.closest('.preference-field').remove();
        }

        function resetDynamicFields() {
            // Reset to single address field
            const addressContainer = document.getElementById('addressesContainer');
            addressContainer.innerHTML = `
                <div class="form-row address-row">
                    <div class="form-group">
                        <label>Address Type</label>
                        <select class="addressType" required>
                            <option value="">Select Type</option>
                            <option value="EMAIL">Email</option>
                            <option value="SMS">SMS</option>
                            <option value="POSTAL">Postal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Address Value</label>
                        <input type="text" class="addressValue" required placeholder="Enter address">
                    </div>
                </div>
            `;

            // Reset to single preference field
            const preferencesContainer = document.getElementById('preferencesContainer');
            preferencesContainer.innerHTML = `
                <div class="form-group">
                    <select class="preferenceType" required>
                        <option value="">Select Preference</option>
                        <option value="EMAIL">Email Notifications</option>
                        <option value="SMS">SMS Notifications</option>
                        <option value="POSTAL">Postal</option>
                    </select>
                </div>
            `;
        }

        // Utility functions
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
    </script>
</body>
</html>
